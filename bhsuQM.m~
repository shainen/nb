function bhsuQM

tmax=20;

Nt = 200;
dt = tmax/Nt;

t=[0:dt:tmax-dt];

S = 3;
U = 1;
mu = 1;
J = 0.01;

Jx=[0,1,0;1,0,1;0,1,0]/sqrt(2);
Jy=i*[0,-1,0;1,0,-1;0,1,0]/sqrt(2);
Jz=[1,0,0;0,0,0;0,0,-1];

JxS=cell(1,S);
JyS=cell(1,S);
JzS=cell(1,S);
for j=1:S,
    JxS{j}=sparse(kron(kron(eye(3^(j-1)),Jx),eye(3^(S-j))));
    JyS{j}=sparse(kron(kron(eye(3^(j-1)),Jy),eye(3^(S-j))));
    JzS{j}=sparse(kron(kron(eye(3^(j-1)),Jz),eye(3^(S-j))));
end

HQM=sparse(3^S,3^S);
for j=1:S
    HQM=HQM+JzS{j}*JzS{j}-JzS{j};
    for k=j+1:S
        HQM=HQM-J*(JxS{j}*JxS{k}+JyS{j}*JyS{k});
    end
end

HQMf=full(HQM);

[Vn,Em]=eig(HQMf);

En=diag(Em);

init=zeros(3^S,1);
init(16,1)=1;

cn=Vn'*init;
m1=Vn'*(JzS{1}*Vn);
m2=Vn'*(JzS{2}*Vn);
m3=Vn'*(JzS{3}*Vn);

AvgSz1=zeros(Nt,1);
AvgSz2=zeros(Nt,1);
AvgSz3=zeros(Nt,1);

for j=1:Nt
    vec1=exp(-i*t(j)*En).*cn;
    vec2=exp(-i*t(j)*En).*cn;
    vec1=exp(-i*t(j)*En).*cn;
    AvgSz1(j)=vec1'*(m1*vec1);
    AvgSz2(j)=(cn'.*exp(i*t(j)*En'))*(m2*(exp(-i*t(j)*En).*cn));
    AvgSz3(j)=(cn'.*exp(i*t(j)*En'))*(m3*(exp(-i*t(j)*En).*cn));
end
[x,y]=eig(Jz)
%plot the results
figure
hold on
%plot(t,X(:,1),'r');
plot(t,AvgSz1,'b');
plot(t,AvgSz2,'r');
plot(t,AvgSz3,'y');
%legend('n for p=0');